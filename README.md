# üõ†Ô∏è Chapter 05 ‚Äî Driver Assignment Service

## üéØ Objective
The **Driver-Assignment-Service** is responsible for listening to bin fill alerts (FillAlert) generated by the Bin-Service, automatically assigning the affected bin to the nearest driver, and sending a notification (AssignmentNotif) to an external service (Notification-Service).  
It also provides the ability to **unassign** a bin if its fill level drops below the alert threshold.

---

## üîÑ Communication Flow

### Bin-Service
- When a bin's fill level exceeds the threshold:
  - Produces a **FillAlert** message to the Kafka topic `fill-alert`.
- When a bin‚Äôs level drops below the threshold:
  - Updates the bin status.
  - Calls the Driver-Assignment-Service API to disable any active assignments related to this bin.

### Driver-Assignment-Service
1. **Alert Reception**
   - Consumes `fill-alert` messages via Kafka.
2. **Assignment**
   - Checks if the bin is already assigned.
   - Fetches available drivers from the **Driver-Service**.
   - Finds the nearest driver using **coordinates (latitude/longitude)** stored in Driver-Service.
   - Calculates distance using the **Haversine formula**.
   - Creates an assignment record and produces an **AssignmentNotif** message to Kafka (for Notification-Service).
3. **Unassignment**
   - Marks all assignments as inactive for a bin if its fill level drops below the threshold.
   - Produces an **AssignmentNotif** of type `UNASSIGNMENT`.

---

## üì¶ Kafka Topics Used
- **fill-alert** ‚Üí produced by Bin-Service, consumed by Driver-Assignment-Service.
- **assignment-notif** ‚Üí produced by Driver-Assignment-Service, consumed by Notification-Service.

---

## üõ†Ô∏è Main Classes

### 1. `AssignmentService`
- Contains business logic:
  - Checks if a bin is already assigned.
  - Retrieves available drivers via `DriverClient`.
  - Finds the nearest driver using the **Haversine formula**.
  - Saves the assignment in the database.
  - Emits an **AssignmentNotif**.
  - Disables assignments if necessary.

### 2. `FillAlertConsumer`
- Listens to Kafka messages on the `fill-alert` topic.
- Calls `AssignmentService.assign()`.

### 3. `AssignmentController`
- Exposes one endpoint:
  - `PUT /api/assignments/{binId}` ‚Üí Disable all active assignments for a bin.

### 4. `KafkaConfig`
- Configures:
  - **Producer** for `AssignmentNotif`.
  - **Consumer** for `FillAlert` (KafkaListener with manual acknowledgment).

---
